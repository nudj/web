version: '1.0'

steps:

  build:
    title: Build
    type: build
    image_name: nudj/web
    tag: latest
    dockerfile: Dockerfile
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}
      - ENVKEY=${{ENVKEY_STAGING}}

  push_latest:
    title: Push
    type: push
    candidate: '${{build}}'
    tag: latest
    credentials:
      username: '${{dockerUsername}}'
      password: '${{dockerPassword}}'

  deploy:
    title: Deploy
    description: Deploy latest web to staging environment
    image: nudj/alpine-openssh-client
    working_directory: /home/${{NUDJ_STAGING_USER}}/staging
    commands:
      - mkdir ~/.ssh
      - echo "${{NUDJ_STAGING_SSH_KEY}}" | tr ',' '\n' > ~/.ssh/id_nudj_staging
      - chmod 0600 ~/.ssh/id_nudj_staging
      - eval "$(ssh-agent -s)"
      - ssh-add ~/.ssh/id_nudj_staging
      - ssh-keyscan ${{NUDJ_STAGING_HOSTNAME}} >> ~/.ssh/known_hosts
      - ssh -t ${{NUDJ_STAGING_USER}}@${{NUDJ_STAGING_HOSTNAME}} /bin/sh -c 'echo 'Deploying' && docker pull ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}} && docker-compose -f /home/${{NUDJ_STAGING_USER}}/staging/docker-compose.yml up -d --force-recreate --no-deps ${{CF_REPO_NAME}}'
