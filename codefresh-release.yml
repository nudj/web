version: '1.0'

steps:

  build_production:
    title: Build production
    type: build
    image_name: nudj/web
    tag: production
    dockerfile: Dockerfile
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}
      - ENVKEY=${{ENVKEY_PRODUCTION}}

  push_production:
    title: Push production
    type: push
    candidate: '${{build_production}}'
    tag: ${{CF_BRANCH}}
    credentials:
      username: '${{dockerUsername}}'
      password: '${{dockerPassword}}'

  github_release:
    title: Github Release
    description: Release the latest tag on Github
    image: nudj/create-github-release
    working_directory: 'IMAGE_WORK_DIR'
    environment:
      - TOKEN=${{GITHUB_ACCESS_TOKEN}}
    commands:
      - /bin/sh -c "node . ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"

  build_demo:
    title: Build demo
    type: build
    image_name: nudj/web
    tag: demo
    dockerfile: Dockerfile
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}
      - ENVKEY=${{ENVKEY_DEMO}}

  push_demo:
    title: Push demo
    type: push
    candidate: '${{build_demo}}'
    tag: demo
    credentials:
      username: '${{dockerUsername}}'
      password: '${{dockerPassword}}'
